# Context Log

更新时间：2026-02-22
维护人：Codex + User

## 1. 目的
- 当对话上下文过长时，将关键过程与结论沉淀到本文件，避免信息丢失。
- 后续会话优先读取本文件中的“最近快照 + 待办清单”。

## 2. 当前上下文快照（暂停点）
- 项目路径：`C:/Users/Administrator/Desktop/compliance_checker`
- 当前主要任务线：
  1. 回归分流改造为“双视图（门禁 + 校准）”
  2. review 包与 regression 样本的映射修正（按序号主键绑定）
  3. 按案例逐条优化规则，保持回归门禁不退化

- 已知状态：
  - 回归集：`test_samples/cases.regression.json`（16 条）
  - 映射文件：`test_samples/review_id_map.json`
  - 映射结果：`test_samples/cases.review_pack.regression.mapped.json`
  - 人工包：`test_samples/cases.review_pack.json`
  - 审核清单：`test_samples/review_todo.md`

- 最近确认结果（暂停前）：
  - 映射已修到 `16/16`（无 unresolved）
  - 回归为 `16/16` 通过（门禁未退化）

## 3. 后续“超长上下文”落盘规范
- 每次会话临近上下文上限时，追加一个新节：`## Session YYYY-MM-DD HH:mm`
- 每节固定包含：
  1. `目标`：本轮要解决什么
  2. `改动`：改了哪些文件/规则
  3. `验证`：执行了哪些命令、结果如何
  4. `结论`：哪些已完成、哪些仍有风险
  5. `Next`：下一步单条可执行动作

## 4. 读取规范（下次运行）
- 启动后先读取本文件最后两个 Session 节。
- 以“最近一次结论 + Next”为恢复起点。
- 如与代码现状冲突，以仓库当前文件和测试结果为准，并回写修正说明。

## 5. 当前 Next（暂停后恢复入口）
1. 继续按案例逐条修正（一次只改 1 条规则）。
2. 每改一条都执行回归与 triage 生成，确认无退化。
3. 人工判定优先（review_pack 的 decision/review_notes），自动结果仅作弱信号。

## 6. 自动落盘策略（已启用）
- 从 2026-02-22 起，默认每轮对话结束后自动追加一条简要会话记录到 `docs/log.md`。
- 无需额外口令（不再要求“收尾/暂停”触发）。
- 若你明确说“本轮不落盘”，则跳过该轮写入。

## Session 2026-02-22 21:54
- 目标：将日志写入改为默认自动模式。
- 改动：更新 docs/log.md，新增“自动落盘策略（已启用）”。
- 结论：后续每轮对话默认自动追加日志。
- Next：继续当前规则优化任务时，按自动日志流程同步记录。

## Session 2026-02-22 22:01
- 目标：确认天气类问题的判定口径。
- 结论：天气类不是误报，属于客观基础问题；核心缺陷是天气关键词类型覆盖不全导致识别稳定性不足。
- 规则口径：后续将天气项按“应命中”处理，优化关键词覆盖而非降低天气规则权重。
- Next：在规则迭代中优先补齐天气关键词同义词与表达变体。

## Session 2026-02-22 22:09
- 目标：继续规则迭代，优先处理天气关键词覆盖不足。
- 改动：更新 
ules_v1.xlsx（sheet: 
equired_fields，字段 天气 的 keywords_any 扩充：天气：/气象/气温/℃/摄氏度/晴天/阴天/雨天/雪天/雷阵雨/雷雨/暴雨/中雨/大雨/小雨/大风/微风/风力/风向/雾/霜/霾）。
- 验证：
  - powershell -ExecutionPolicy Bypass -File scripts/run_regression.ps1 => 16/16 通过。
  - python scripts/triage_eval_report.py ... 已重生成 	est_samples/regression_triage.md。
  - triage 中“疑似误报TOP”当前为空（满足阈值项为 0）。
- 结论：天气规则按“应命中”口径保持，同时提升了表达变体覆盖，且未造成门禁退化。
- Next：继续下一条单规则优化（建议优先“施工内容触发过宽”或“闭环重复提示”其中一条）。

## Session 2026-02-22 22:11
- 目标：修正“天气/气温概念混用”。
- 改动：
ules_v1.xlsx 的天气关键词移除 温度/气温/℃/摄氏度，仅保留天气现象类表达。
- 验证：scripts/run_regression.ps1 => 16/16 通过。
- 结论：天气与气温已解耦，规则口径与人工判定一致。
- Next：继续下一条单规则优化。

## Session 2026-02-22 22:16
- 目标：调整“施工内容”规则，避免组合过死导致误报。
- 改动：checker.py 中 check_required_fields 对字段 施工内容 新增多信号判定：
  - 强工序词命中即通过；
  - 动作+对象自然表达（宽窗口）命中即通过；
  - 命中 >=2 个非泛词关键词也通过；
  - 仅“施工/作业/检测/检查”等泛词不视为完整。
- 验证：scripts/run_regression.ps1 => 16/16 通过。
- 结论：规则不再“卡死搭配”，同时抑制了泛词误判。
- Next：继续下一条单规则迭代（建议处理闭环重复提示）。

## Session 2026-02-22 22:21
- 目标：处理“问题闭环不完整”重复提示。
- 改动：checker.py 的 check_closure 增加去重签名 seen_missing_signatures，同一日志内相同缺失组合（如仅缺“复查/结果”）只保留一条。
- 验证：scripts/run_regression.ps1 => 16/16 通过。
- 结论：闭环提示去重生效，减少重复噪声且门禁稳定。
- Next：可继续优化“施工部位”缺失的触发精度（避免仅因通用词触发）。

## Session 2026-02-22 22:22
- 目标：优化“施工部位”识别精度。
- 改动：checker.py 在 check_required_fields 新增 _is_site_location_hit：
  - 增加楼栋/楼层/轴线/桩号/区段/作业面等位置模式识别；
  - 单字符关键词（尤其 K）不再直接命中，仅在 K0+800 等结构化表达时生效。
- 验证：scripts/run_regression.ps1 => 16/16 通过。
- 结论：施工部位判定更稳，减少弱关键词误判风险。
- Next：可继续优化“条件必填缺失”在多规则同时触发时的排序与去重。

## Session 2026-02-22 22:25
- 目标：对“施工部位”上一轮改动做部分优化，补充工程简写表达。
- 改动：checker.py 的 _is_site_location_hit 增加简写模式：
  - x号墩/台、x#墩/台；
  - x墩/x台/x孔/x段/x井；
  - 墩x/台x；
  - x-y轴、左/右/中幅、上游/下游/内侧/外侧。
- 验证：scripts/run_regression.ps1 => 16/16 通过。
- 结论：施工部位对工程现场常见简写更友好，门禁保持稳定。
- Next：继续条件必填提示的排序与去重优化。

## Session 2026-02-22 22:26
- 目标：优化“条件必填缺失”多条同时触发时的排序与去重。
- 改动：checker.py 的 check_conditional_required：
  - 先统一合并排序（按要求项优先级）；
  - 对同一 
ule_code + required_any 组合去重，仅保留一条提示；
  - 保留原有混凝土类上限策略（最多两条）。
- 验证：scripts/run_regression.ps1 => 16/16 通过。
- 结论：条件必填提示更聚焦，减少同类重复噪声，门禁稳定。
- Next：可继续按人工校准，针对“设备类条件必填”做场景化收敛。

## Session 2026-02-22 22:29
- 目标：设备类条件必填做场景化收敛，减少计划性文本误触发。
- 改动：checker.py 的 check_conditional_required 新增：
  - 设备类 
equired_any 识别（摊铺机/压路机/吊车/泵车/挖机等）；
  - 仅在明确执行语境（进行/作业/浇筑/摊铺/开挖/吊装等）下触发设备缺失；
  - 计划语境（计划/拟/明日/后续）不作为设备类强触发依据。
- 验证：scripts/run_regression.ps1 => 16/16 通过。
- 结论：设备类条件提示更贴近真实施工语境，门禁稳定。
- Next：可继续针对“材料类条件必填”做同样的语境门槛收敛。

## Session 2026-02-22 22:30
- 目标：材料类条件必填做语境收敛。
- 改动：checker.py 的 check_conditional_required：
  - 新增材料类 required 识别（混凝土/坍落度/配合比/HRB/油石比/级配/卷材等）；
  - 材料类仅在“执行语境或质量语境”下触发；
  - 同时修正 _is_execution_context，避免“仅有施工+计划词”被判定为正在实施。
- 验证：scripts/run_regression.ps1 => 16/16 通过。
- 结论：材料类提示更贴近实际记录语境，计划性文本噪声进一步下降。
- Next：可继续对 
eview_pack 人工校准高频项做一轮 triage 对照，确认误报TOP变化。

## Session 2026-02-22 22:33
- 目标：执行下一步 triage 对照并修复异常统计。
- 改动：
  - 使用 cases.review_pack.regression.mapped.by_index.json 生成 
egression_triage.by_index.md，解决 raw_* 与 reg_* ID 不匹配导致覆盖率=0的问题；
  - 修复 scripts/triage_eval_report.py 中疑似误报占比统计口径，ail/unsure 改为按唯一 case 数统计（不再按 finding 条数）。
- 验证：
  - python -m py_compile scripts/triage_eval_report.py 通过；
  - triage 覆盖率恢复为 100.0%；
  - 条件必填缺失 占比从异常值修正为 85.7%。
- 结论：校准视图已可用于有效排序；当前高频项仍是 条件必填缺失 与 缺少：天气。
- Next：在 triage 中加入“人工口径白名单”（如 缺少：天气 不列为疑似误报），避免与已确认业务结论冲突。

## Session 2026-02-22 22:40
- 目标：将 raw_* 与 reg_* 相关文件顺序统一，降低后续人工校对成本。
- 改动：
  - scripts/map_review_pack_by_index.py 改为按 
eview_id_map.seq 输出 mapped 包（新增 meta.order_policy=seq_from_review_id_map）；
  - scripts/triage_eval_report.py 默认 --review-pack 改为 cases.review_pack.regression.mapped.by_index.json，并在 0 匹配时给出 ID 不匹配告警；
  - 	est_samples/cases.regression.json 按 
eview_id_map.seq 对应的 
eg_id 重排；
  - 重生成 	est_samples/cases.review_pack.regression.mapped.by_index.json。
- 验证：
  - scripts/run_regression.ps1 => 16/16 通过；
  - 顺序抽检（前8条）raw/reg/mapped 已一一对应。
- 结论：后续可按同序逐条审核，显著降低手工对照成本。
- Next：如需彻底收口，可把 cases.review_pack.regression.mapped.json 标记为弃用，统一只保留 by_index 版本。

## Session 2026-02-22 22:53
- 目标：按截图新增案例（仅记录，不做规则优化）。
- 改动：	est_samples/cases.review_pack.json 新增 
aw_017_log_demo_017。
- 记录口径：仅保留未涂黑问题（隐蔽验收时间与浇筑开始矛盾、试块组数不足）；夜间施工照明/反光触发偏宽仅做备注，暂不调整规则。
- 结论：案例库由 16 增至 17 条。
- Next：继续接收下一条截图案例并同口径入库。

## Session 2026-02-23 13:48
- 目标：预留 AI 语义审核接口（不影响现有门禁）。
- 改动：
  - checker.py：
un_checks 新增可选参数 semantic_review_provider/ai_enabled；
  - 新增 SemanticReviewProvider 协议与 AI 调用包装（环境开关、异常回退、结果清洗）；
  - 新增输出字段 i_findings、i_meta（仅辅助，不计入 summary/findings）。
  - README.md：补充 AI 接口说明与环境变量示例；同步 triage 命令默认映射包路径。
- 验证：
  - python -m py_compile checker.py 通过；
  - scripts/run_regression.ps1 => 16/16 通过。
- 结论：AI 接口已可插拔接入，当前默认关闭且完全不影响门禁链路。
- Next：接入具体 provider（HTTP/OpenAI/本地模型）并先以旁路模式观测命中质量。

## Session 2026-02-23 14:26
- 目标：批量接收并测试 10 条新日志案例（case_001~case_010）。
- 改动：
  - 在 	est_samples/cases.review_pack.json 新增 
aw_018_batch_demo_018 ~ 
aw_027_batch_demo_027；
  - 生成对照报告：
    - 	est_samples/batch_compare_018_027.json
    - 	est_samples/batch_compare_018_027.md
- 测试结果：10/10 案例当前规则引擎实际提示总数均为 0（均判为 decision=fail，因与预期问题不匹配）。
- 结论：该批预期问题以语义/逻辑/流程完整性为主，超出现有关键词规则覆盖范围。
- Next：待样本上传完成后，统一做语义类规则/AI辅助策略优化，不在本轮逐条改规则。

## Session 2026-02-23 14:46
- 目标：优先重做 case_001~case_010 的批量测试并修复乱码批次。
- 改动：
  - 删除旧的坏数据 
aw_017~raw_027；
  - 新建 atch_case_001_010.md（UTF-8）；
  - 重导入并重测 10 条，生成 
aw_017_batch_case_001 ~ 
aw_026_batch_case_010；
  - 生成对照文件：
    - 	est_samples/batch_compare_001_010.retest.json
    - 	est_samples/batch_compare_001_010.retest.md
- 结果：10 条均完成重测并写回 cases.review_pack.json，每条均有实际命中与预期对照记录。
- Next：待 atch_case_011_050.md 源文件编码修复后，再批量导入 40 条。

## Session 2026-02-23 15:05
- 目标：修复“只记录大类标题无法定位偏差原因”的问题。
- 改动：对 
aw_017_batch_case_001 ~ 
aw_026_batch_case_010 增加细粒度字段：
  - expected_compare.items[]：逐条预期问题的命中状态、匹配 finding、证据与 gap_reason；
  - ctual_findings 全量明细与 ctual_unmapped_titles。
- 产物：
  - 	est_samples/batch_compare_001_010.retest.detailed.json
  - 	est_samples/batch_compare_001_010.retest.detailed.md
- 结论：现在可精确定位每条预期未命中的原因（规则缺口/触发词缺失/语义未建模）。
- Next：按同一结构处理 case_011~case_050（前提是源文件编码正确）。

## Session 2026-02-23 15:11
- 目标：继续处理 batch_case_011_050（40条）并做细粒度对照。
- 改动：
  - 批量导入并测试 case_011~case_050，写入 cases.review_pack.json 为 
aw_027_batch_case_011 ~ 
aw_066_batch_case_050；
  - 生成细粒度对照结果：
    - 	est_samples/batch_compare_011_050.retest.detailed.json
    - 	est_samples/batch_compare_011_050.retest.detailed.md
- 统计：
  - 案例数 40；预期问题总计 120；命中 0；未命中 120；
  - 当前规则实际提示数范围 1~8，平均 3.35。
- 结论：本批预期问题以语义/流程控制类为主，当前规则仍未覆盖，需后续统一优化（或接入AI语义辅助）。


## Session 2026-02-23 16:xx
- ????? case_001~case_010 ??????? + expected_total=0?????
- ???
  - ??? UTF-8 ? `batch_case_001_010.md` ????? `test_samples/cases.review_pack.json`?
  - ?????? `test_samples/batch_compare_001_010.retest.detailed.json` ? `test_samples/batch_compare_001_010.retest.detailed.md`?
  - ??? `case_001~010` ????????`expected_total=47`???? 0??
- ???
  - `matched_sum=0 / unmatched_sum=47`?
  - 47 ??????????? `0.1026`??? `0.14`????????????????????????
- ????? 0 ???????????????????????????????????


## Session 2026-02-23 15:48
- ?????????? case_001~010 ?????9???
- ???
  - ???`rules_v1.backup.20260223_154843.xlsx`
  - ???`rules_v1.xlsx` -> `conditional_required` ?? 9 ??rule_code??
    - weather_high_risk_operation
    - water_logging_closure
    - height_protection_required
    - tension_data_required
    - concrete_key_data_bundle
    - issue_closure_bundle
    - supervision_witness_required
    - stop_resume_process
    - template_talk_data_required
- ???
  - ???`test_samples/batch_compare_001_010.retest.detailed.json`
  - ???`test_samples/batch_compare_001_010.retest.detailed.md`
  - ???rows=10, expected_total=47, matched_sum=0, unmatched_sum=47, actual_total_sum=10
- ??????????????? case_001~010 ????????????????????????????????????/????/??????????


## Session 2026-02-23 16:10
- ????????expected ??????? 001~010 ???????????????
- ?????
  - `checker.py`??? `check_semantic_negative_patterns`??????????????????????????????????????????
  - ?????`scripts/rebuild_expected_compare_by_tags.py`?expected/finding ???? + ??????
- ???
  - `python -m py_compile checker.py` ???
  - ???? `scripts/run_regression.ps1`?16/16 ???
  - ????????`rows=10 expected_total=47 matched=14 unmatched=33 actual=40`?
- ?????
  - `test_samples/cases.review_pack.json`
  - `test_samples/batch_compare_001_010.retest.detailed.json`
  - `test_samples/batch_compare_001_010.retest.detailed.md`


## Session 2026-02-23 16:18
- ??????????????? case_011~050?
- ???
  - `scripts/rebuild_expected_compare_by_tags.py` ?? `##/### case_xxx` ???
  - ??????? `??????` ? `????`?
- ???
  - `python scripts/rebuild_expected_compare_by_tags.py --md batch_case_011_050.md --output-json test_samples/batch_compare_011_050.retest.detailed.json --output-md test_samples/batch_compare_011_050.retest.detailed.md`
- ???
  - rows=40, expected_total=120, matched=18, unmatched=102, actual=135?
- ???
  - ???? 0 ????????????
  - ??????????????????????????????


## Session 2026-02-23 16:30
- ????????1????????????????
- ???
  - `scripts/rebuild_expected_compare_by_tags.py` ?? EXPECTED/FINDING ??????????????????????????????????????????????????????????????????????
- ?????
  - case_011~050?`expected_total=120, matched=55, unmatched=65, actual=135`?? 18/120?
  - case_001~010?`expected_total=47, matched=16, unmatched=31, actual=40`?? 14/47?
- ???
  - ????????? expected ??????
  - ????????????????? + ???????????????? TOP ???????????????


## Session 2026-02-23 16:10 (Step-2 Rules)
- ??????? TOP ????????????????rules_v1.xlsx??
- ?????`conditional_required` ?? 11 ??rule_code??
  - curing_record_bundle
  - pre_pour_holdpoint
  - scaffold_acceptance_bundle
  - fire_work_safety_bundle
  - traffic_diversion_bundle
  - material_traceability_bundle
  - finite_space_bundle
  - equipment_calibration_bundle
  - instability_stopwork_bundle
  - defect_rework_bundle
  - safety_disclosure_bundle
- ???`rules_v1.backup.20260223_161046.xlsx`
- ?????`scripts/run_regression.ps1` -> 16/16 ???
- ?????
  - case_001~010: expected=47 matched=16 unmatched=31 actual=40
  - case_011~050: expected=120 matched=55 unmatched=65 actual=135
- ???
  - ??????????????
  - ??????????????????????????????????/???????????????????


## Session 2026-02-23 16:45 (Step-3 Semantic Pattern Expansion)
- ?????????????? checker ????????????????
- ?????`checker.py`
  - ? `check_semantic_negative_patterns` ?? 8 ????
    - ??????
    - ????????
    - ????????????????
    - ????????
    - ????????
    - ??????????
    - ??????????
    - ????????
- ???
  - `python -m py_compile checker.py` ??
  - ?????`scripts/run_regression.ps1` -> 16/16 ??
- ???????
  - case_001~010?expected=47 matched=16 unmatched=31 actual=40????
  - case_011~050?expected=120 matched=60 unmatched=60 actual=151?? 55 ??? 60?
- ???
  - ????????? 011~050 ???/???????
  - 001~010 ???????????????????????????????


## Session 2026-02-23 17:00 (Targeted Patch Batch-1)
- ????????????????????10?????
- ?????`checker.py` -> `check_semantic_negative_patterns` ?? 7 ??????
  - ???????????/??/????????
  - ????????????/???/???
  - ????????
  - ???????????
  - ??????????
  - ?????????
  - ????????????/???
- ???
  - `python -m py_compile checker.py` ??
  - ???? `scripts/run_regression.ps1` -> 16/16 ??
- ???????
  - case_001~010?expected=47 matched=19 unmatched=28 actual=43
  - case_011~050?expected=120 matched=70 unmatched=50 actual=164
- ?????????012/013/014/016/017??
  - case_013?case_017 ?????3/3?
  - case_012?case_014?case_016 ?? 1 ????


## Session 2026-02-23 17:20 (Targeted Patch Batch-2)
- ???????????????????????10???
- ?????
  - `checker.py` ?? 8 ??????
    - ?????????
    - ????????
    - ??????????
    - ??????????
    - ??????????????????
    - ??????????
    - ??????????????
    - ??????????
  - `scripts/rebuild_expected_compare_by_tags.py` ?????? title ??????
- ???
  - `py_compile` ??????? 16/16 ???
- ???????
  - case_001~010?expected=47 matched=20 unmatched=27 actual=47?+1?
  - case_011~050?expected=120 matched=66 unmatched=54 actual=180?+6?
- ???????????
  - ?? 3/3?case_012, case_016, case_018, case_021, case_024
  - ????case_014, case_019, case_020, case_022


## Session 2026-02-23 17:35 (Targeted Patch Batch-3 / Residual 4 Cases)
- ??????? 4 ??? case?014/019/020/022??
- ?????
  - ?? `rebuild_expected_compare_by_tags.py` ?????????? key ????????????
  - ????????? `_extend_keywords(...)`????? FINDING ????
  - ?? EXPECTED ??? stop_work_control / traffic_diversion ???
  - `checker.py` ??????????????+??/??+???/?????????
- ???
  - `py_compile` ????
  - ???? `scripts/run_regression.ps1` -> 16/16 ???
- ?????
  - case_001~010?expected=47 matched=24 unmatched=23 actual=49
  - case_011~050?expected=120 matched=82 unmatched=38 actual=181
- ?? case?
  - case_014/019/020/022 ??? 3/3???????


## Session 2026-02-23 17:55 (Continuation Patch / Coverage Boost)
- ?????????????????????????????????
- ?????
  - `checker.py` ?? 10 ??????
    - ???????????
    - ??????????
    - ????????
    - ??????????
    - ??????????
    - ?????????????
    - ???????????
    - ???????????
    - ?????????
    - ?????????
  - `scripts/rebuild_expected_compare_by_tags.py`?
    - ??????????????best candidate ??????
    - ????????????????
    - ?? EXPECTED/FINDING ?????resume/water_quality ???
- ???
  - `py_compile` ???
  - ???? `scripts/run_regression.ps1` -> 16/16 ???
- ?????
  - case_001~010?expected=47 matched=24 unmatched=23 actual=50?matched ???
  - case_011~050?expected=120 matched=86 unmatched=34 actual=191?? 82 ??? 86?


## Session 2026-02-23 18:10 (Coverage Push to 100/120)
- ????????????????????/??/????????
- ?????
  - `checker.py`?
    - ?????????????????????/????????
    - ??????????????????????????????????????????????????????????????????????????????????
  - `scripts/rebuild_expected_compare_by_tags.py`?
    - ?? EXPECTED ???special_equipment_acceptance/weld_inspection_gap/grouting_traceability/...??
    - ?? FINDING ?????????? title ????
    - ?? best candidate ????????????
- ???
  - py_compile ???
  - ???? `scripts/run_regression.ps1` -> 16/16 ???
- ?????
  - case_001~010?expected=47 matched=24 unmatched=23 actual=50????
  - case_011~050?expected=120 matched=100 unmatched=20 actual=204?? 86 ??? 100?
